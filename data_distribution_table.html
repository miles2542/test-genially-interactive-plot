<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uber Data Atlas | Executive Scrubber View</title>

    <!-- FONTS: Inter (Standard for modern UI) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- DATA SOURCE -->
    <script src="data_payload.js"></script>

    <style>
        /* =========================================
           1. UBER DESIGN SYSTEM (TOKENS)
           ========================================= */
        :root {
            /* Palette */
            --uber-black: #000000;
            --uber-white: #FFFFFF;
            --data-green: #47B275;
            /* Primary Positive */
            --data-red: #F25138;
            /* Critical/Alert */
            --data-orange: #FF7D49;
            /* Warning/Raw safe range */

            /* Grays */
            --gray-100: #F6F6F6;
            --gray-200: #EEEEEE;
            --gray-300: #E2E2E2;
            --gray-600: #545454;

            /* Dimensions */
            --sidebar-width: 260px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background: var(--gray-100);
            height: 100vh;
            display: flex;
            overflow: hidden;
            color: var(--uber-black);
        }

        /* =========================================
           2. SIDEBAR (CONTROLS)
           ========================================= */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--uber-white);
            border-right: 1px solid var(--gray-300);
            display: flex;
            flex-direction: column;
            padding: 24px;
            z-index: 20;
        }

        .brand {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.5px;
            color: var(--uber-black);
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .brand svg rect:last-child {
            fill: var(--data-green);
        }

        /* Green cube for Data Prep focus */

        /* DROPDOWN STYLING */
        .control-group {
            margin-bottom: 40px;
        }

        .label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 8px;
            display: block;
        }

        select {
            width: 100%;
            padding: 10px 12px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 500;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            background: var(--uber-white);
            color: var(--uber-black);
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s;
        }

        select:focus {
            border-color: var(--uber-black);
        }

        /* Scrubber Info */
        .scrubber-info {
            background: var(--gray-100);
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 40px;
            font-size: 13px;
            font-weight: 500;
            line-height: 1.5;
        }

        .scrubber-info strong {
            font-weight: 700;
        }

        .scrubber-info .raw {
            color: var(--data-red);
            font-weight: 700;
        }

        .scrubber-info .filtered {
            color: var(--data-green);
            font-weight: 700;
        }

        /* VERTICAL SLIDER CONTAINER */
        .scrubber-container {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
            height: 250px;
        }

        /* The Custom Vertical Slider Track */
        input[type=range][orient=vertical] {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            width: 8px;
            height: 100%;
            padding: 0;
            cursor: ns-resize;
            background: var(--gray-300);
            border-radius: 4px;
        }

        /* Custom Thumb for clarity */
        input[type=range][orient=vertical]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--uber-black);
            border: 2px solid var(--uber-white);
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }


        .scrubber-labels {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 13px;
            font-weight: 500;
            text-align: right;
        }

        .scrubber-labels span {
            padding: 2px 0;
            transition: color 0.3s;
        }

        .scrubber-labels .raw-label {
            color: var(--data-red);
        }

        .scrubber-labels .filtered-label {
            color: var(--data-green);
        }


        /* Footer */
        .footer {
            margin-top: auto;
            font-size: 10px;
            color: var(--gray-600);
            line-height: 1.4;
            border-top: 1px solid var(--gray-200);
            padding-top: 16px;
        }

        /* =========================================
           3. MAIN VIEW (DATA TABLE)
           ========================================= */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: var(--uber-white);
        }

        /* HEADER INFO */
        .info-bar {
            padding: 24px 32px 10px 32px;
            background: var(--uber-white);
            border-bottom: 2px solid var(--gray-300);
            /* Separator line */
        }

        .metric-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--uber-black);
            margin: 0;
            letter-spacing: -0.5px;
        }

        .metric-subtitle {
            font-size: 16px;
            font-weight: 400;
            color: var(--gray-600);
            margin-top: 4px;
            margin-bottom: 12px;
        }

        /* TABLE SCROLL AREA */
        .table-wrapper {
            flex-grow: 1;
            overflow: auto;
            position: relative;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            font-size: 13px;
        }

        /* TABLE HEADERS */
        th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--gray-100);
            color: var(--uber-black);
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 10px 12px;
            text-align: right;
            border-bottom: 1px solid var(--gray-300);
        }

        th:first-child {
            position: sticky;
            left: 0;
            z-index: 20;
            text-align: left;
            background: var(--gray-100);
            border-right: 2px solid var(--uber-black);
            min-width: 90px;
        }

        /* TABLE CELLS */
        td {
            padding: 8px 12px;
            text-align: right;
            white-space: nowrap;
            border-bottom: 1px solid var(--gray-100);
            color: var(--uber-black);
            font-variant-numeric: tabular-nums;
            transition: background-color 0.2s, color 0.2s;
        }

        td:first-child {
            position: sticky;
            left: 0;
            z-index: 5;
            text-align: left;
            background: var(--uber-white);
            font-weight: 500;
            font-size: 13px;
            border-right: 2px solid var(--uber-black);
        }

        tr:hover td {
            background-color: #FAFAFA;
        }

        tr:hover td:first-child {
            background-color: #FAFAFA;
        }

        /* BOUNDARY LINE (The Horizontal Scrubber) */
        tr.boundary-row td {
            border-top: 2px solid var(--uber-black) !important;
        }

        /* Dynamic Visual Styles for Raw vs Filtered */
        .raw-data-style {
            color: var(--data-red);
            opacity: 0.9;
        }

        .filtered-data-style {
            color: var(--uber-black);
            opacity: 1.0;
        }

        /* Highlight classes */
        .val-mean,
        .val-max {
            border-left: 1px solid var(--gray-300);
        }

        .val-mean {
            font-weight: 600;
        }

        .val-max {
            font-weight: 600;
        }
    </style>
</head>

<body>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="brand">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="2" y="2" width="9" height="9" fill="black" />
                <rect x="13" y="2" width="9" height="9" fill="black" />
                <rect x="2" y="13" width="9" height="9" fill="black" />
                <rect x="13" y="13" width="9" height="9" fill="#47B275" />
            </svg>
            Data Atlas
        </div>

        <div class="control-group">
            <label class="label">Select Feature</label>
            <select id="featureSelect">
                <!-- Javascript will populate this -->
            </select>
        </div>

        <div class="scrubber-info">
            <strong>Data Scrubber Mode:</strong>
            <p style="margin-top: 8px;">Rows <span class="raw">ABOVE</span> the boundary display <span
                    class="raw">RAW</span> data.</p>
            <p>Rows <span class="filtered">BELOW</span> the boundary display <span class="filtered">FILTERED</span>
                data.</p>
        </div>

        <div class="label" style="text-align: center; margin-bottom: 10px;">Boundary Control</div>
        <div class="scrubber-container">
            <div class="scrubber-labels">
                <span class="raw-label">RAW (ALL)</span>
                <span></span>
                <span class="filtered-label">FILTERED (ALL)</span>
            </div>
            <!-- Vertical Slider: min=0 (Filtered/Bottom), max=NumRows (Raw/Top) -->
            <input type="range" id="rowScrubber" min="0" orient="vertical">
            <div class="scrubber-labels">
                <span class="raw-label" id="topBoundary">Feb 2019</span>
                <span style="visibility: hidden">mid</span>
                <span class="filtered-label" id="bottomBoundary">Sep 2025</span>
            </div>
        </div>

        <div class="footer">
            NYC TLC Trip Records<br>
            2019 - 2025<br>
            <span style="opacity: 0.5">Confidential â€¢ Internal Use</span>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="info-bar">
            <div>
                <h1 class="metric-title" id="displayTitle">Loading...</h1>
                <div class="metric-subtitle">Monthly Statistical Distribution - Boundary: <span id="boundaryInfo">All
                        Raw Data</span></div>
            </div>
        </div>

        <div class="table-wrapper">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Audit Month</th>
                        <th>Total Rows</th>
                        <!-- Safe/Distribution Group -->
                        <th>MIN</th>
                        <th>P01</th>
                        <th>P50</th>
                        <!-- Avg -->
                        <th class="val-mean" style="min-width: 80px">MEAN</th>
                        <!-- Risk Group -->
                        <th style="border-left: 1px solid var(--gray-300)">STD</th>
                        <th>P99</th>
                        <th>P99.9</th>
                        <!-- Max -->
                        <th class="val-max" style="min-width: 80px">MAX</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Javascript populates this -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. INITIALIZATION & SETUP
        // ==========================================

        if (typeof ATLAS_DATA === 'undefined') {
            document.getElementById('displayTitle').innerText = "ERROR: Data not loaded.";
            return;
        }

        const featureSelect = document.getElementById('featureSelect');
        const rowScrubber = document.getElementById('rowScrubber');
        const tableBody = document.getElementById('tableBody');
        const displayTitle = document.getElementById('displayTitle');
        const boundaryInfo = document.getElementById('boundaryInfo');

        const allDates = ATLAS_DATA.dates;
        const numRows = allDates.length;

        // Set Scrubber Range based on data length
        rowScrubber.max = numRows;
        rowScrubber.step = 1;

        // Populate Dropdown & Set Default
        const features = Object.keys(ATLAS_DATA.features).sort();
        let defaultFeature = 'base_passenger_fare';
        if (!features.includes(defaultFeature)) {
            defaultFeature = features[0];
        }

        features.forEach(feat => {
            const opt = document.createElement('option');
            opt.value = feat;
            opt.text = feat.replace(/_/g, " ").toUpperCase();
            featureSelect.appendChild(opt);
            if (feat === defaultFeature) {
                opt.selected = true;
            }
        });

        // Set initial scrubber value: Start at full RAW (index = numRows)
        rowScrubber.value = numRows;

        // Update Scrubber Date Labels
        document.getElementById('topBoundary').innerText = allDates[0];
        document.getElementById('bottomBoundary').innerText = allDates[numRows - 1];


        // ==========================================
        // 2. HELPER FUNCTIONS (VISUALIZATION)
        // ==========================================

        const fmt = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const fmtInt = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 });

        /**
         * Generates the background style string
         * @param {number} val - The cell value
         * @param {number} maxVal - The GLOBAL MAX for this column (scaling factor)
         * @param {string} type - 'safe', 'risk', 'bar'
         * @param {boolean} isFiltered - true if filtered data (Green), false if raw (Red/Orange)
         */
        function getStyle(val, maxVal, type, isFiltered) {
            if (val === null || val === undefined) return '';

            const absVal = Math.abs(val);
            const ratio = Math.min(absVal / maxVal, 1);
            const pct = ratio * 100;

            let barColor = isFiltered ? 'var(--data-green)' : 'var(--data-red)';
            let gradColor = isFiltered ? `rgba(71, 178, 117, ${ratio * 0.3})` : `rgba(242, 81, 56, ${ratio * 0.4})`;

            if (type === 'bar') {
                // Ensure bars for MAX use the critical color in RAW mode
                if (!isFiltered) barColor = 'var(--data-red)';

                return `background: linear-gradient(90deg, ${barColor} ${pct}%, transparent ${pct}%)`;
            }

            if (type === 'safe' && !isFiltered) {
                // Raw safe stats (MIN/P01/P50): Use Orange tint to signal caution/noise
                gradColor = `rgba(255, 125, 73, ${ratio * 0.3})`;
            }
            if (type === 'risk' && isFiltered) {
                // Filtered risk stats (STD/P99): Use muted red/green combo if standard deviation is high even after filter
                gradColor = `rgba(71, 178, 117, ${ratio * 0.3})`;
            }

            // Return gradient style for cells (risk/safe columns)
            return `background-color: ${gradColor}`;
        }

        // ==========================================
        // 3. RENDER LOGIC
        // ==========================================

        function render() {
            const featName = featureSelect.value;
            // boundaryIndex: number of rows displaying RAW data (0 to numRows)
            const boundaryIndex = parseInt(rowScrubber.value);
            const featData = ATLAS_DATA.features[featName];
            const stats = featData.stats;

            // Update Header Title
            displayTitle.innerText = featName.replace(/_/g, " ").toUpperCase();

            // Update Boundary Info text
            let currentModeText = "";
            if (boundaryIndex === 0) {
                currentModeText = "All Filtered Data (Boundary at top)";
            } else if (boundaryIndex === numRows) {
                currentModeText = "All Raw Data (Boundary at bottom)";
            } else {
                currentModeText = `Boundary set AFTER ${allDates[boundaryIndex - 1]} (${boundaryIndex} Raw Rows)`;
            }
            boundaryInfo.innerText = currentModeText;

            // Clear Table
            tableBody.innerHTML = '';

            // Generate Rows
            ATLAS_DATA.dates.forEach((date, i) => {

                // Determine which dataset to use for this row
                // If index 'i' is less than the boundary index, use RAW
                const isRawRow = (i < boundaryIndex);
                const isFilteredRow = !isRawRow;
                const dataSetKey = isRawRow ? 'raw' : 'processed';
                const data = featData[dataSetKey];

                const tr = document.createElement('tr');

                // Add boundary class for visual separation
                // The boundary line should appear *above* the first FILTERED row
                if (i === boundaryIndex) {
                    tr.classList.add('boundary-row');
                }

                // Helper to get value safely
                const getVal = (suffix) => data[suffix] ? data[suffix][i] : 0;

                // Values
                const v_min = getVal('min');
                const v_p01 = getVal('p01');
                const v_p50 = getVal('p50');
                const v_mean = getVal('mean');
                const v_std = getVal('std');
                const v_p99 = getVal('p99');
                const v_p999 = getVal('p99.9');
                const v_max = getVal('max');
                const v_rows = data['rows'] ? data['rows'][i] : 0;

                // Apply base style based on state (for text color/font style)
                const baseClass = isRawRow ? 'raw-data-style' : 'filtered-data-style';

                // MAX bar color needs explicit setting to match text color for MAX
                let maxBarTextColor = isRawRow ? 'var(--data-red)' : 'var(--data-green)';

                tr.innerHTML = `
                    <td>${date}</td>
                    <td class="${baseClass}" style="color: var(--gray-600); opacity: ${isRawRow ? 0.9 : 1.0}">${fmtInt.format(v_rows)}</td>
                    
                    <td class="${baseClass}" style="${getStyle(v_min, stats.min_max, 'safe', isFilteredRow)}">${fmt.format(v_min)}</td>
                    <td class="${baseClass}" style="${getStyle(v_p01, stats.p01_max, 'safe', isFilteredRow)}">${fmt.format(v_p01)}</td>
                    <td class="${baseClass}" style="${getStyle(v_p50, stats.p50_max, 'safe', isFilteredRow)}">${fmt.format(v_p50)}</td>
                    
                    <td class="val-mean ${baseClass}" style="${getStyle(v_mean, stats.mean_max, 'bar', isFilteredRow)}">${fmt.format(v_mean)}</td>
                    
                    <td class="${baseClass}" style="border-left: 1px solid var(--gray-300); ${getStyle(v_std, stats.std_max, 'risk', isFilteredRow)}">${fmt.format(v_std)}</td>
                    <td class="${baseClass}" style="${getStyle(v_p99, stats.p99_max, 'risk', isFilteredRow)}">${fmt.format(v_p99)}</td>
                    <td class="${baseClass}" style="${getStyle(v_p999, stats.p999_max, 'risk', isFilteredRow)}">${fmt.format(v_p999)}</td>
                    
                    <td class="val-max ${baseClass}" style="${getStyle(v_max, stats.max_max, 'bar', isFilteredRow)}; color: ${maxBarTextColor};">${fmtInt.format(v_max)}</td>
                `;

                tableBody.appendChild(tr);
            });
        }

        // ==========================================
        // 4. EVENT LISTENERS
        // ==========================================

        featureSelect.addEventListener('change', render);
        rowScrubber.addEventListener('input', render);

        // Initial setup for default feature
        if (numRows > 0) {
            render();
        }

    </script>
</body>

</html>
